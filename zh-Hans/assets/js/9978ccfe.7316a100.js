"use strict";(self.webpackChunkavalonia_docs=self.webpackChunkavalonia_docs||[]).push([[6175],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>h});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),c=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},u=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),p=c(a),m=r,h=p["".concat(s,".").concat(m)]||p[m]||d[m]||i;return a?n.createElement(h,l(l({ref:t},u),{},{components:a})):n.createElement(h,l({ref:t},u))}));function h(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,l=new Array(i);l[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[p]="string"==typeof e?e:r,l[1]=o;for(var c=2;c<i;c++)l[c]=a[c];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},8493:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var n=a(87462),r=(a(67294),a(3905));const i={description:"TUTORIALS - Music Store App"},l="Add Data Persistence",o={unversionedId:"tutorials/music-store-app/add-data-persistence",id:"tutorials/music-store-app/add-data-persistence",title:"Add Data Persistence",description:"TUTORIALS - Music Store App",source:"@site/i18n/zh-Hans/docusaurus-plugin-content-docs/current/tutorials/music-store-app/add-data-persistence.md",sourceDirName:"tutorials/music-store-app",slug:"/tutorials/music-store-app/add-data-persistence",permalink:"/avalonia-docs/zh-Hans/docs/next/tutorials/music-store-app/add-data-persistence",draft:!1,editUrl:"https://github.com/AvaloniaUI/avalonia-docs/tree/main/docs/tutorials/music-store-app/add-data-persistence.md",tags:[],version:"current",frontMatter:{description:"TUTORIALS - Music Store App"},sidebar:"documentationSidebar",previous:{title:"Add Items to the User's Collection",permalink:"/avalonia-docs/zh-Hans/docs/next/tutorials/music-store-app/add-items-to-users-collection"},next:{title:"Load Data at Start-up",permalink:"/avalonia-docs/zh-Hans/docs/next/tutorials/music-store-app/load-data-at-startup"}},s={},c=[{value:"Album Model  ",id:"album-model--",level:2},{value:"Album View Model",id:"album-view-model",level:2},{value:"Main Window View Model",id:"main-window-view-model",level:2},{value:"Bitmap Cache Activated",id:"bitmap-cache-activated",level:2}],u={toc:c},p="wrapper";function d(e){let{components:t,...a}=e;return(0,r.kt)(p,(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"add-data-persistence"},"Add Data Persistence"),(0,r.kt)("p",null,"On this page, you will add some code to the album model (business service) to save the user's album collection to disk, so that it can be recovered when the app next runs."),(0,r.kt)("p",null,"As a welcome side-effect, this will also activate the album cover cache - so that album cover images can be retrieved from disk (if they exist), rather than from the Web API."," "),(0,r.kt)("h2",{id:"album-model--"},"Album Model "," "),(0,r.kt)("p",null,"Follow this procedure to add persistence services (save and load) to the album model:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Stop the app if it is running."),(0,r.kt)("li",{parentName:"ul"},"Locate and open the ",(0,r.kt)("strong",{parentName:"li"},"Album.cs")," file in the ",(0,r.kt)("strong",{parentName:"li"},"/Models")," folder."),(0,r.kt)("li",{parentName:"ul"},"Add the code to implement save to disk, as shown:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'public async Task SaveAsync()\n{\n    if (!Directory.Exists("./Cache"))\n    {\n        Directory.CreateDirectory("./Cache");\n    }\n\n    using (var fs = File.OpenWrite(CachePath))\n    {\n        await SaveToStreamAsync(this, fs);\n    }\n}\n\npublic Stream SaveCoverBitmapStream()\n{\n    return File.OpenWrite(CachePath + ".bmp");\n}\n\nprivate static async Task SaveToStreamAsync(Album data, Stream stream)\n{\n    await JsonSerializer.SerializeAsync(stream, data).ConfigureAwait(false);\n}\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Add the code to implement load from disk, as shown:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'public static async Task<Album> LoadFromStream(Stream stream)\n{\n    return (await JsonSerializer.DeserializeAsync<Album>(stream).ConfigureAwait(false))!;\n}\n\npublic static async Task<IEnumerable<Album>> LoadCachedAsync()\n{\n    if (!Directory.Exists("./Cache"))\n    {\n        Directory.CreateDirectory("./Cache");\n    }\n\n    var results = new List<Album>();\n\n    foreach (var file in Directory.EnumerateFiles("./Cache"))\n    {\n        if (!string.IsNullOrWhiteSpace(new DirectoryInfo(file).Extension)) continue;\n\n        await using var fs = File.OpenRead(file);\n        results.Add(await Album.LoadFromStream(fs).ConfigureAwait(false));\n    }\n\n    return results;\n}\n')),(0,r.kt)("h2",{id:"album-view-model"},"Album View Model"),(0,r.kt)("p",null,"Your next step is to add a method to the album view model that it can call the business service persistence save methods:"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"SaveAsync")," - persists the album text data as a JSON file,"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"SaveCoverBitmapStream")," - saves the cover art as a bitmap (.BMP) file."),(0,r.kt)("p",null,"To alter the album view model , follow this procedure:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Locate and open the ",(0,r.kt)("strong",{parentName:"li"},"AlbumViewModel.cs")," file."),(0,r.kt)("li",{parentName:"ul"},"Add the method as shown:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"public async Task SaveToDiskAsync()\n{\n    await _album.SaveAsync();\n\n    if (Cover != null)\n    {\n        var bitmap = Cover;\n\n        await Task.Run(() =>\n        {\n            using (var fs = _album.SaveCoverBitmapStream())\n            {\n                bitmap.Save(fs);\n            }\n        });\n    }\n}\n")),(0,r.kt)("p",null,"Once again, you will notice that the bitmap is saved from a copy in case the ",(0,r.kt)("inlineCode",{parentName:"p"},"Cover")," property gets changed mid-operation by another thread."," "),(0,r.kt)("h2",{id:"main-window-view-model"},"Main Window View Model"),(0,r.kt)("p",null,"Lastly, you will call the new album view model persistence method ",(0,r.kt)("inlineCode",{parentName:"p"},"SaveToDiskAsync")," whenever the dialog returns with a non-null result."," "),(0,r.kt)("p",null,"To alter the main window view model, follow this procedure:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Locate and open the ",(0,r.kt)("strong",{parentName:"li"},"MainWindowViewModel.cs")," file."),(0,r.kt)("li",{parentName:"ul"},"Add the code ",(0,r.kt)("inlineCode",{parentName:"li"},"await result.SaveToDiskAsync();")," as shown below.")),(0,r.kt)("p",null,"Your code to initialize the reactive command will now look like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"BuyMusicCommand = ReactiveCommand.CreateFromTask(async () =>\n{\n    var store = new MusicStoreViewModel();\n\n    var result = await ShowDialog.Handle(store);\n\n    if (result != null)\n    {\n        Albums.Add(result);\n        await result.SaveToDiskAsync();\n    }\n});\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Click ",(0,r.kt)("strong",{parentName:"li"},"Debug")," to compile and run the project."),(0,r.kt)("li",{parentName:"ul"},"Click the icon button."),(0,r.kt)("li",{parentName:"ul"},"Type some search text."),(0,r.kt)("li",{parentName:"ul"},"Click an album to select it."),(0,r.kt)("li",{parentName:"ul"},"Click ",(0,r.kt)("strong",{parentName:"li"},"Buy Album"),"."),(0,r.kt)("li",{parentName:"ul"},"Repeat another time for a different album.")),(0,r.kt)("p",null,"You will not see any difference in the app yet. But you can check to see that the persistence files are being written. To do this open the project location and browse to the ",(0,r.kt)("strong",{parentName:"p"},"/bin/Debug")," folder. Open the folder for your .NET version, and you will find the ",(0,r.kt)("strong",{parentName:"p"},"/Cache")," folder there. You will see two cache files for each of the albums that you just selected."),(0,r.kt)("h2",{id:"bitmap-cache-activated"},"Bitmap Cache Activated"),(0,r.kt)("p",null,"Notice that because the ",(0,r.kt)("inlineCode",{parentName:"p"},"SaveToDiskAsync")," method writes both the JSON data and the album cover art bitmap to the cache folder, this step has effectively activated the bitmap loading cache behaviour that you built earlier. This is where: if an album cover has already been retrieved from the Web API and saved to the cache, the next bitmap load will be from the file not the API - saving time and making the app more responsive."),(0,r.kt)("p",null,"To show that the bitmap loading cache is now in operation, follow this procedure:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Stop the app if it is running."),(0,r.kt)("li",{parentName:"ul"},"Locate and open the ",(0,r.kt)("strong",{parentName:"li"},"Album.cs")," file in the ",(0,r.kt)("strong",{parentName:"li"},"/Models")," folder."," "),(0,r.kt)("li",{parentName:"ul"},"Check to see that there is still a debug breakpoint in the ",(0,r.kt)("inlineCode",{parentName:"li"},"LoadCoverBitmapAsync")," method at this line:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'return File.OpenRead(CachePath + ".bmp");\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Click ",(0,r.kt)("strong",{parentName:"li"},"Debug")," to compile and run the project."),(0,r.kt)("li",{parentName:"ul"},"Click the icon button."),(0,r.kt)("li",{parentName:"ul"},"Type the same search text you just used."),(0,r.kt)("li",{parentName:"ul"},"Select one of the ",(0,r.kt)("em",{parentName:"li"},"same")," albums from the previous test run."),(0,r.kt)("li",{parentName:"ul"},"Click ",(0,r.kt)("strong",{parentName:"li"},"Buy Album"))),(0,r.kt)("p",null,"The debug breakpoint should stop the app. This demonstrates that the album art is about to be read from disk, rather than retrieved from the Web API."," "),(0,r.kt)("p",null,"On the next page, you will complete the persistence feature, and load the user's album collection from the cache when the app first starts up."))}d.isMDXComponent=!0}}]);