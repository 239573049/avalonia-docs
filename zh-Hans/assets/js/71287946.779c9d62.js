"use strict";(self.webpackChunkavalonia_docs=self.webpackChunkavalonia_docs||[]).push([[60278],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(n),h=i,m=d["".concat(l,".").concat(h)]||d[h]||u[h]||r;return n?a.createElement(m,o(o({ref:t},c),{},{components:n})):a.createElement(m,o({ref:t},c))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:i,o[1]=s;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},83453:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var a=n(87462),i=(n(67294),n(3905));const r={id:"data-persistence",title:"Data Persistence"},o=void 0,s={unversionedId:"guides/deep-dives/reactiveui/data-persistence",id:"version-0.10.x/guides/deep-dives/reactiveui/data-persistence",title:"Data Persistence",description:"For better UX, your app should be capable of saving state to the disk when the app is suspending and of restoring state when the app is resuming. ReactiveUI provides facilities allowing you to persist application state by serializing the view model tree when the app is shutting down or suspending. In this tutorial we are going to look through the capabilities of ReactiveUI that help us manage the state which outlives the process.",source:"@site/i18n/zh-Hans/docusaurus-plugin-content-docs/version-0.10.x/guides/deep-dives/reactiveui/data-persistence.md",sourceDirName:"guides/deep-dives/reactiveui",slug:"/guides/deep-dives/reactiveui/data-persistence",permalink:"/avalonia-docs/zh-Hans/docs/guides/deep-dives/reactiveui/data-persistence",draft:!1,editUrl:"https://github.com/AvaloniaUI/avalonia-docs/tree/main/versioned_docs/version-0.10.x/guides/deep-dives/reactiveui/data-persistence.md",tags:[],version:"0.10.x",frontMatter:{id:"data-persistence",title:"Data Persistence"},sidebar:"documentationSidebar",previous:{title:"Routing",permalink:"/avalonia-docs/zh-Hans/docs/guides/deep-dives/reactiveui/routing"},next:{title:"Binding to Sorted/Filtered Data",permalink:"/avalonia-docs/zh-Hans/docs/guides/deep-dives/reactiveui/binding-to-sorted-filtered-list"}},l={},p=[{value:"Annotating The ViewModel",id:"annotating-the-viewmodel",level:3},{value:"Creating The View",id:"creating-the-view",level:3},{value:"Creating The Suspension Driver",id:"creating-the-suspension-driver",level:3},{value:"Wiring The Things Together",id:"wiring-the-things-together",level:3}],c={toc:p},d="wrapper";function u(e){let{components:t,...n}=e;return(0,i.kt)(d,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"For better UX, your app should be capable of saving state to the disk when the app is suspending and of restoring state when the app is resuming. ",(0,i.kt)("a",{parentName:"p",href:"https://reactiveui.net/"},"ReactiveUI")," provides facilities allowing you to persist application state by serializing the view model tree when the app is shutting down or suspending. In this tutorial we are going to look through the capabilities of ReactiveUI that help us manage the state which outlives the process."),(0,i.kt)("h3",{id:"annotating-the-viewmodel"},"Annotating The ViewModel"),(0,i.kt)("p",null,"View model serialization is a tricky business. We have to decide, which properties of the view model to save on application shutdown and which ones to recreate. Taking our typical search screen view model, we definitely want to save and restore the search query, so we annotate the public property with the ",(0,i.kt)("inlineCode",{parentName:"p"},"[DataMember]")," attribute. We don't want to save the state of the commands to the disk, so we mark the command with the ",(0,i.kt)("inlineCode",{parentName:"p"},"[IgnoreDataMember]")," attribute. These attributes are available in the standard library, but one can easily use other annotations, for example, ",(0,i.kt)("inlineCode",{parentName:"p"},"[JsonProperty]")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"[JsonIgnore]"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"[DataContract]\npublic class MainViewModel : ReactiveObject\n{\n    private string _searchQuery;\n\n    public MainViewModel() \n    {\n        var canSearch = this\n            .WhenAnyValue(x => x.SearchQuery)\n            .Select(query => !string.IsNullOrWhiteSpace(query));\n        \n        Search = ReactiveCommand.CreateFromTask(\n            () => Task.Delay(1000), // a long-running operation\n            canSearch);\n    }\n\n    [IgnoreDataMember]\n    public ReactiveCommand<Unit, Unit> Search { get; }\n    \n    [DataMember]\n    public string SearchQuery \n    {\n        get => _searchQuery;\n        set => this.RaiseAndSetIfChanged(ref _searchQuery, value);\n    }\n}\n")),(0,i.kt)("p",null,"There is no need to save the state of a ",(0,i.kt)("a",{parentName:"p",href:"https://reactiveui.net/docs/handbook/commands/"},"reactive command")," which implements the ",(0,i.kt)("inlineCode",{parentName:"p"},"ICommand")," interface. ",(0,i.kt)("inlineCode",{parentName:"p"},"ReactiveCommand<TIn, TOut>")," class is typically initialized in the constructor, its ",(0,i.kt)("inlineCode",{parentName:"p"},"CanExecute")," indicator usually fully depends on view model properties and gets recalculated each time any of those properties change."),(0,i.kt)("h3",{id:"creating-the-view"},"Creating The View"),(0,i.kt)("p",null,"Next, we modify the ",(0,i.kt)("inlineCode",{parentName:"p"},"MainWindow")," class to follow the standard ReactiveUI pattern."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"public class MainWindow : ReactiveWindow<MainViewModel>\n{\n    public MainWindow()\n    {\n        AvaloniaXamlLoader.Load(this);\n        this.WhenActivated(disposable => { });\n    }\n}\n")),(0,i.kt)("p",null,"The XAML of our ",(0,i.kt)("inlineCode",{parentName:"p"},"ReactiveWindow")," will look like as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-markup"},'<Window xmlns="https://github.com/avaloniaui"\n        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"\n        x:Class="ReactiveUI.Samples.Suspension.MainWindow"\n        Title="ReactiveUI.Samples.Suspension">\n    <TextBox Text="{Binding SearchQuery, Mode=TwoWay}"\n             Watermark="Place, enter the search query"\n             Margin="20" />\n</Window>\n')),(0,i.kt)("h3",{id:"creating-the-suspension-driver"},"Creating The Suspension Driver"),(0,i.kt)("p",null,"Here we provide the implementation that uses ",(0,i.kt)("inlineCode",{parentName:"p"},"Newtonsoft.Json")," and saves the application state to a plain text file."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"public class NewtonsoftJsonSuspensionDriver : ISuspensionDriver\n{\n    private readonly string _file;\n    private readonly JsonSerializerSettings _settings = new JsonSerializerSettings\n    {\n        TypeNameHandling = TypeNameHandling.All\n    };\n\n    public NewtonsoftJsonSuspensionDriver(string file) => _file = file;\n\n    public IObservable<Unit> InvalidateState()\n    {\n        if (File.Exists(_file)) \n            File.Delete(_file);\n        return Observable.Return(Unit.Default);\n    }\n\n    public IObservable<object> LoadState()\n    {\n        var lines = File.ReadAllText(_file);\n        var state = JsonConvert.DeserializeObject<object>(lines, _settings);\n        return Observable.Return(state);\n    }\n\n    public IObservable<Unit> SaveState(object state)\n    {\n        var lines = JsonConvert.SerializeObject(state, _settings);\n        File.WriteAllText(_file, lines);\n        return Observable.Return(Unit.Default);\n    }\n}\n")),(0,i.kt)("h3",{id:"wiring-the-things-together"},"Wiring The Things Together"),(0,i.kt)("p",null,"On the final step, we initialize the ",(0,i.kt)("inlineCode",{parentName:"p"},"AutoSuspendHelper"),", following the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/AvaloniaUI/Avalonia/wiki/Application-lifetimes"},"new Avalonia lifetimes pattern"),". In the ",(0,i.kt)("inlineCode",{parentName:"p"},"App.xaml.cs")," file we create an override for the ",(0,i.kt)("inlineCode",{parentName:"p"},"OnFrameworkInitializationCompleted")," method and initialize the variables required for the suspension feature to work fine."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},'public class App : Application\n{\n    public override void Initialize() => AvaloniaXamlLoader.Load(this);\n\n    public override void OnFrameworkInitializationCompleted()\n    {\n        // Create the AutoSuspendHelper.\n        var suspension = new AutoSuspendHelper(ApplicationLifetime);\n        RxApp.SuspensionHost.CreateNewAppState = () => new MainViewModel();\n        RxApp.SuspensionHost.SetupDefaultSuspendResume(new NewtonsoftJsonSuspensionDriver("appstate.json"));\n        suspension.OnFrameworkInitializationCompleted();\n\n        // Load the saved view model state.\n        var state = RxApp.SuspensionHost.GetAppState<MainViewModel>();\n        new MainWindow {DataContext = state}.Show();\n        base.OnFrameworkInitializationCompleted();\n    }\n}\n')),(0,i.kt)("p",null,"In the ",(0,i.kt)("inlineCode",{parentName:"p"},"Program.cs")," file, we add a call to ",(0,i.kt)("inlineCode",{parentName:"p"},".UseReactiveUI()")," to the app builder."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"internal static class Program\n{\n    public static void Main(string[] args) => BuildAvaloniaApp()\n        .StartWithClassicDesktopLifetime(args);\n\n    public static AppBuilder BuildAvaloniaApp()\n        => AppBuilder.Configure<App>()\n            .UsePlatformDetect()\n            .UseReactiveUI()\n            .LogToDebug();\n}\n")),(0,i.kt)("p",null,"Now, we can run the app. If we type some text into the ",(0,i.kt)("inlineCode",{parentName:"p"},"TextBox"),", it will be present there even if we close the app instance and launch a new one. The state is saved to the ",(0,i.kt)("inlineCode",{parentName:"p"},"appstate.json")," file which is placed near the program executable."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"# If you are targeting .NET Core 3, then use\n# netcoreapp3.0 as the CLI argument.\ndotnet run --framework netcoreapp2.1\n")),(0,i.kt)("p",null,'See the "',(0,i.kt)("a",{parentName:"p",href:"https://habr.com/ru/post/462307/"},"Saving Routing State to the Disk in a Cross-Platform .NET Core GUI App with ReactiveUI and Avalonia"),'" blog post to explore how to combine the data persistence feature with ReactiveUI routing and dependency injection. See also ',(0,i.kt)("a",{parentName:"p",href:"https://github.com/reactiveui/ReactiveUI.Samples/tree/a7d06759e27fa17f9c6a77018362a2f8e0c30fa6/avalonia"},"the source code of the sample app")," in the ReactiveUI.Samples repository."))}u.isMDXComponent=!0}}]);